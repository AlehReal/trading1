<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prueba Skool Webhook - Blue Makers</title>
  <style>
    :root {
      --blue-dark: #0a1122;
      --blue-mid: #112340;
      --blue-light: #1b355e;
      --text-white: #ffffff;
      --text-light: #b4c0db;
      --button-blue: #1677ff;
      --button-blue-hover: #0e57c5;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--blue-dark);
      color: var(--text-white);
      margin: 0;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: var(--blue-mid);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
      color: #4ea8ff;
      margin-top: 0;
      border-bottom: 2px solid var(--blue-light);
      padding-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    h2 {
      color: var(--text-light);
      margin-top: 30px;
    }
    
    .status-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      margin-left: 10px;
    }
    
    .status-success {
      background: var(--success);
      color: white;
    }
    
    .status-warning {
      background: var(--warning);
      color: white;
    }
    
    .status-error {
      background: var(--error);
      color: white;
    }
    
    .form-group {
      margin: 25px 0;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-light);
    }
    
    input, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--blue-light);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-white);
      font-size: 16px;
      box-sizing: border-box;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: #4ea8ff;
    }
    
    textarea {
      min-height: 100px;
      font-family: monospace;
      font-size: 14px;
    }
    
    .button-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin: 30px 0;
    }
    
    button {
      background: var(--button-blue);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 200px;
      justify-content: center;
    }
    
    button:hover {
      background: var(--button-blue-hover);
      transform: translateY(-2px);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    button.secondary {
      background: transparent;
      border: 2px solid var(--blue-light);
      color: var(--text-light);
    }
    
    button.secondary:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .result-container {
      margin-top: 30px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 20px;
      display: none;
    }
    
    .result-container.active {
      display: block;
      animation: fadeIn 0.5s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .result-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .result-title h3 {
      margin: 0;
      color: #4ea8ff;
    }
    
    .result-content {
      font-family: monospace;
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #4ea8ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .log-entry {
      padding: 10px;
      margin: 10px 0;
      border-left: 4px solid #4ea8ff;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 0 5px 5px 0;
    }
    
    .log-entry.success {
      border-left-color: var(--success);
    }
    
    .log-entry.error {
      border-left-color: var(--error);
    }
    
    .log-entry.warning {
      border-left-color: var(--warning);
    }
    
    .log-time {
      font-size: 12px;
      color: var(--text-light);
      margin-bottom: 5px;
    }
    
    .log-message {
      font-size: 14px;
    }
    
    .section {
      background: rgba(16, 119, 255, 0.05);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      border: 1px solid rgba(16, 119, 255, 0.1);
    }
    
    .code-block {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 14px;
      overflow-x: auto;
      margin: 15px 0;
    }
    
    .url-display {
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      word-break: break-all;
      margin: 10px 0;
      border-left: 4px solid #4ea8ff;
    }
    
    .success { color: var(--success); }
    .error { color: var(--error); }
    .warning { color: var(--warning); }
    
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Panel de Pruebas - Integraci√≥n Skool</h1>
    
    <div class="section">
      <h2>üìä Estado del Sistema</h2>
      <div id="systemStatus">Cargando estado del sistema...</div>
    </div>
    
    <div class="section">
      <h2>üß™ Probar Invitaci√≥n a Skool</h2>
      <p>Esta prueba enviar√° una invitaci√≥n real a Skool usando el webhook configurado.</p>
      
      <div class="form-group">
        <label for="testEmail">Email para probar:</label>
        <input type="email" id="testEmail" placeholder="usuario@ejemplo.com" value="test@example.com">
      </div>
      
      <div class="form-group">
        <label>URL que se usar√°:</label>
        <div class="url-display" id="skoolUrlDisplay">Cargando URL de Skool...</div>
      </div>
      
      <div class="button-group">
        <button id="testSkoolBtn">
          <span class="loading" id="skoolLoading" style="display: none;"></span>
          <span id="skoolText">Probar Invitaci√≥n a Skool</span>
        </button>
        
        <button id="testEmailBtn" class="secondary">
          <span class="loading" id="emailLoading" style="display: none;"></span>
          <span id="emailText">Probar Email de Bienvenida</span>
        </button>
      </div>
      
      <div id="skoolResult" class="result-container">
        <div class="result-title">
          <h3>Resultado de la Prueba</h3>
          <span id="resultStatus" class="status-badge">Estado</span>
        </div>
        <div class="result-content" id="resultContent"></div>
      </div>
    </div>
    
    <div class="section">
      <h2>üîç Debug de URL de Skool</h2>
      <p>Si tienes problemas, pega aqu√≠ la URL completa de tu webhook de Skool para depurarla:</p>
      
      <div class="form-group">
        <label for="skoolWebhookUrl">URL de Webhook de Skool:</label>
        <input type="text" id="skoolWebhookUrl" placeholder="https://webhook.skool.com/invite">
        <small style="color: var(--text-light); margin-top: 5px; display: block;">
          Formato esperado: https://webhook.skool.com/invite?email=bob@gmail.com
        </small>
      </div>
      
      <button id="debugUrlBtn" class="secondary">
        <span class="loading" id="debugLoading" style="display: none;"></span>
        <span>Depurar URL</span>
      </button>
      
      <div id="debugResult" class="result-container">
        <div class="result-title">
          <h3>Resultado del Debug</h3>
        </div>
        <div class="result-content" id="debugContent"></div>
      </div>
    </div>
    
    <div class="section">
      <h2>üìù Logs de Actividad</h2>
      <div id="activityLogs">
        <div class="log-entry">
          <div class="log-time" id="currentTime">--:--:--</div>
          <div class="log-message">Esperando actividad...</div>
        </div>
      </div>
    </div>
    
    <div class="section">
      <h2>üìã Ejemplos de Uso</h2>
      
      <h3>Comando cURL para probar:</h3>
      <div class="code-block">
curl -X POST http://localhost:4242/test-skool-invite \<br>
  -H "Content-Type: application/json" \<br>
  -d '{"email": "test@ejemplo.com"}'
      </div>
      
      <h3>URL de Skool formateada correctamente:</h3>
      <div class="code-block">
# Si tu webhook es: https://webhook.skool.com/invite<br>
# La URL final ser√≠a: https://webhook.skool.com/invite?email=usuario@gmail.com<br>
# <br>
# Si ya tiene par√°metros: https://webhook.skool.com/invite?token=abc123<br>
# La URL final ser√≠a: https://webhook.skool.com/invite?token=abc123&email=usuario@gmail.com
      </div>
      
      <h3>Respuestas esperadas de Skool:</h3>
      <ul style="color: var(--text-light);">
        <li><span class="success">‚úÖ 200 OK</span> - Invitaci√≥n enviada exitosamente</li>
        <li><span class="warning">‚ö† 400 Bad Request</span> - Email inv√°lido o faltante</li>
        <li><span class="error">‚ùå 404 Not Found</span> - URL del webhook incorrecta</li>
        <li><span class="error">‚ùå 500 Internal Error</span> - Error en el servidor de Skool</li>
      </ul>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const testEmailInput = document.getElementById('testEmail');
      const testSkoolBtn = document.getElementById('testSkoolBtn');
      const testEmailBtn = document.getElementById('testEmailBtn');
      const debugUrlBtn = document.getElementById('debugUrlBtn');
      const skoolUrlInput = document.getElementById('skoolWebhookUrl');
      const skoolUrlDisplay = document.getElementById('skoolUrlDisplay');
      const skoolResult = document.getElementById('skoolResult');
      const resultContent = document.getElementById('resultContent');
      const resultStatus = document.getElementById('resultStatus');
      const debugResult = document.getElementById('debugResult');
      const debugContent = document.getElementById('debugContent');
      const systemStatus = document.getElementById('systemStatus');
      const activityLogs = document.getElementById('activityLogs');
      const currentTime = document.getElementById('currentTime');
      
      // Actualizar hora actual
      function updateTime() {
        const now = new Date();
        currentTime.textContent = now.toLocaleTimeString();
      }
      setInterval(updateTime, 1000);
      updateTime();
      
      // Agregar log
      function addLog(message, type = 'info') {
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry ${type}`;
        
        const time = document.createElement('div');
        time.className = 'log-time';
        time.textContent = new Date().toLocaleTimeString();
        
        const msg = document.createElement('div');
        msg.className = 'log-message';
        msg.textContent = message;
        
        logEntry.appendChild(time);
        logEntry.appendChild(msg);
        activityLogs.insertBefore(logEntry, activityLogs.firstChild);
        
        // Mantener m√°ximo 10 logs
        while (activityLogs.children.length > 10) {
          activityLogs.removeChild(activityLogs.lastChild);
        }
      }
      
      // Obtener configuraci√≥n del sistema
      async function loadSystemStatus() {
        try {
          const response = await fetch('/status');
          const data = await response.json();
          
          let html = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
              <div>
                <strong>Servidor:</strong> <span class="success">‚óè Online</span><br>
                <small>${data.serverTime}</small>
              </div>
              <div>
                <strong>Stripe:</strong> 
                ${data.services.stripe.configured ? '<span class="success">‚óè Configurado</span>' : '<span class="error">‚óè No configurado</span>'}
              </div>
              <div>
                <strong>Email:</strong> 
                ${data.services.email.configured ? '<span class="success">‚óè Configurado</span>' : '<span class="error">‚óè No configurado</span>'}
              </div>
              <div>
                <strong>Skool:</strong> 
                ${data.services.skool.configured ? '<span class="success">‚óè Configurado</span>' : '<span class="warning">‚óè No configurado</span>'}
              </div>
            </div>
          `;
          
          if (data.services.skool.configured) {
            html += `<div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px;">
              <strong>URL de ejemplo Skool:</strong><br>
              <code style="font-size: 12px;">${data.services.skool.exampleUrl}</code>
            </div>`;
            
            // Mostrar URL en el display
            skoolUrlDisplay.textContent = data.services.skool.exampleUrl;
          }
          
          systemStatus.innerHTML = html;
          
        } catch (error) {
          systemStatus.innerHTML = `<span class="error">Error cargando estado: ${error.message}</span>`;
          addLog(`Error cargando estado: ${error.message}`, 'error');
        }
      }
      
      // Probar endpoint
      async function testEndpoint(endpoint, data, button, loadingSpan, textSpan) {
        button.disabled = true;
        loadingSpan.style.display = 'inline-block';
        textSpan.textContent = 'Procesando...';
        
        try {
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          
          const result = await response.json();
          
          // Mostrar resultado
          skoolResult.classList.add('active');
          resultContent.textContent = JSON.stringify(result, null, 2);
          
          // Actualizar estado
          if (result.error || result.skipped) {
            resultStatus.textContent = 'Error';
            resultStatus.className = 'status-badge status-error';
            addLog(`‚ùå ${endpoint}: ${result.error || result.reason}`, 'error');
          } else if (result.invited || result.success) {
            resultStatus.textContent = '√âxito';
            resultStatus.className = 'status-badge status-success';
            addLog(`‚úÖ ${endpoint}: Operaci√≥n exitosa`, 'success');
          } else {
            resultStatus.textContent = 'Advertencia';
            resultStatus.className = 'status-badge status-warning';
            addLog(`‚ö† ${endpoint}: Respuesta inesperada`, 'warning');
          }
          
        } catch (error) {
          skoolResult.classList.add('active');
          resultContent.textContent = `Error: ${error.message}`;
          resultStatus.textContent = 'Error';
          resultStatus.className = 'status-badge status-error';
          addLog(`‚ùå Error en ${endpoint}: ${error.message}`, 'error');
        } finally {
          button.disabled = false;
          loadingSpan.style.display = 'none';
          textSpan.textContent = button === testSkoolBtn ? 'Probar Invitaci√≥n a Skool' : 'Probar Email de Bienvenida';
        }
      }
      
      // Debug URL
      async function debugSkoolUrl() {
        const url = skoolUrlInput.value.trim();
        
        if (!url) {
          alert('Por favor, ingresa una URL para depurar');
          return;
        }
        
        debugUrlBtn.disabled = true;
        const debugLoading = document.getElementById('debugLoading');
        debugLoading.style.display = 'inline-block';
        
        try {
          const response = await fetch('/debug-skool-webhook', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
          });
          
          const result = await response.json();
          
          debugResult.classList.add('active');
          debugContent.textContent = JSON.stringify(result, null, 2);
          addLog(`üîç Debug URL: ${url.substring(0, 50)}...`, 'info');
          
        } catch (error) {
          debugResult.classList.add('active');
          debugContent.textContent = `Error: ${error.message}`;
          addLog(`‚ùå Error debug URL: ${error.message}`, 'error');
        } finally {
          debugUrlBtn.disabled = false;
          debugLoading.style.display = 'none';
        }
      }
      
      // Configurar eventos
      testSkoolBtn.addEventListener('click', () => {
        const email = testEmailInput.value.trim();
        
        if (!email || !email.includes('@')) {
          alert('Por favor, ingresa un email v√°lido');
          return;
        }
        
        addLog(`üß™ Probando invitaci√≥n Skool para: ${email}`, 'info');
        testEndpoint('/test-skool-invite', { email }, testSkoolBtn, 
          document.getElementById('skoolLoading'), document.getElementById('skoolText'));
      });
      
      testEmailBtn.addEventListener('click', () => {
        const email = testEmailInput.value.trim();
        
        if (!email || !email.includes('@')) {
          alert('Por favor, ingresa un email v√°lido');
          return;
        }
        
        addLog(`üìß Probando email para: ${email}`, 'info');
        testEndpoint('/resend-welcome-email', { email }, testEmailBtn,
          document.getElementById('emailLoading'), document.getElementById('emailText'));
      });
      
      debugUrlBtn.addEventListener('click', debugSkoolUrl);
      
      // Permitir Enter en el input de debug
      skoolUrlInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          debugSkoolUrl();
        }
      });
      
      // Cargar estado inicial
      loadSystemStatus();
      
      // Actualizar estado cada 30 segundos
      setInterval(loadSystemStatus, 30000);
      
      addLog('‚úÖ Panel de pruebas cargado correctamente', 'success');
    });
  </script>
</body>
</html>